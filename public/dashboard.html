<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard | FrancNormand</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="dashboard-layout">

    <!-- Sidebar -->
    <aside class="dashboard-sidebar">
      <h2>FrancNormand</h2>
      <nav>
        <ul>
          <li><a href="#">Accueil</a></li>
          <li><a href="#">Mon portefeuille</a></li>
          <li><a href="#">Acheter</a></li>
          <li><a href="#">Envoyer</a></li>
          <li><a href="/logout">D√©connexion</a></li>
        </ul>
      </nav>
    </aside>

    <!-- Contenu principal -->
    <main class="dashboard-main">
      <!-- Bandeau d‚Äôexplication MetaMask -->
      <div id="wallet-info" class="wallet-info">
        <h2>üîó Connecte ton portefeuille MetaMask</h2>
        <p>Pour acc√©der √† toutes les fonctionnalit√©s, connecte ton wallet.</p>
        <p>üëâ Clique sur le bouton ci-dessous.</p>
        <button id="connect-wallet-btn" class="btn">Connecter mon portefeuille</button>
      </div>

      <header class="dashboard-header">
        <h1 id="welcomeTitle">Bienvenue</h1>
        <p>Portefeuille connect√© : <span id="walletAddress">0x...</span></p>
      </header>

      <section class="dashboard-grid">
        <div class="dashboard-card balance-card">
          <h2>Solde actuel</h2>
          <p id="balance">152.34 NORM</p>
        </div>

        <div class="dashboard-card actions-card">
          <h2>Actions rapides</h2>
          <button class="btn" onclick="alert('Fonction acheter √† venir')">Acheter du NORM</button>
          <button class="btn" onclick="alert('Fonction envoyer √† venir')">Envoyer des NORM</button>
        </div>

        <div class="dashboard-card info-card">
          <h2>Derni√®res activit√©s</h2>
          <ul class="activity-log">
            <li>+25 NORM re√ßus - Bienvenue üéâ</li>
            <li>-12.5 NORM envoy√©s √† 0xabc...</li>
            <li>+50 NORM achet√©s via carte</li>
          </ul>
        </div>
      </section>
    </main>
  </div>

  <script>
    async function loadUserData() {
      try {
        const res = await fetch('/me');
        if (!res.ok) throw new Error('Non connect√©');
        const user = await res.json();

        document.getElementById("welcomeTitle").textContent = `Bienvenue ${user.username}`;

        // Si l'utilisateur a d√©j√† un wallet li√©, l'afficher directement
        if (user.wallet) {
          document.getElementById("wallet-info").style.display = "none";
          document.getElementById("walletAddress").textContent = user.wallet;
          localStorage.setItem("userWallet", user.wallet);
        } else {
          document.getElementById("wallet-info").style.display = "block";
        }
      } catch (err) {
        console.error(err);
        window.location.href = "/auth.html";
      }
    }

    // Connexion au wallet MetaMask
    async function connectWallet() {
      if (typeof window.ethereum !== "undefined") {
        try {
          const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
          const userAddress = accounts[0];
          console.log("Wallet connect√©:", userAddress);

          // Sauvegarder l‚Äôadresse localement
          localStorage.setItem("userWallet", userAddress);

          // Envoyer l'adresse au serveur pour lier √† l'utilisateur
          const res = await fetch('/link-wallet', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ wallet: userAddress })
          });

          if (res.ok) {
            console.log("Wallet li√© c√¥t√© serveur !");
            document.getElementById("wallet-info").style.display = "none";
            document.getElementById("walletAddress").textContent = userAddress;
          } else {
            alert("Erreur lors de la sauvegarde du wallet sur le serveur.");
          }
        } catch (error) {
          console.error(error);
          alert("Erreur lors de la connexion √† MetaMask.");
        }
      } else {
        alert("MetaMask n‚Äôest pas install√©. T√©l√©charge-le pour continuer !");
      }
    }

    document.getElementById("connect-wallet-btn").addEventListener("click", connectWallet);

    window.addEventListener("DOMContentLoaded", loadUserData);
  </script>
</body>
</html>
